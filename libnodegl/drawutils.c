/*
 * Copyright 2019 GoPro Inc.
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

#include "drawutils.h"
#include "memory.h"
#include "nodegl.h"

#define BYTES_PER_PIXEL 4 /* RGBA */

static const uint8_t font8[128][8] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x08, 0x08, 0x08, 0x08, 0x00, 0x08, 0x00},
    {0x00, 0x14, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x14, 0x3e, 0x14, 0x14, 0x3e, 0x14, 0x00},
    {0x08, 0x3c, 0x0a, 0x1c, 0x28, 0x28, 0x1e, 0x08}, {0x00, 0x00, 0x22, 0x10, 0x08, 0x04, 0x22, 0x00},
    {0x00, 0x0c, 0x12, 0x0c, 0x52, 0x32, 0x6c, 0x00}, {0x00, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x18, 0x04, 0x04, 0x04, 0x04, 0x18, 0x00}, {0x00, 0x0c, 0x10, 0x10, 0x10, 0x10, 0x0c, 0x00},
    {0x08, 0x2a, 0x1c, 0x7f, 0x1c, 0x2a, 0x08, 0x00}, {0x00, 0x00, 0x08, 0x08, 0x3e, 0x08, 0x08, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x02}, {0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00}, {0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00},
    {0x00, 0x1c, 0x32, 0x2a, 0x2a, 0x26, 0x1c, 0x00}, {0x00, 0x08, 0x0c, 0x08, 0x08, 0x08, 0x1c, 0x00},
    {0x00, 0x1c, 0x22, 0x20, 0x1c, 0x02, 0x3e, 0x00}, {0x00, 0x1c, 0x22, 0x18, 0x20, 0x22, 0x1c, 0x00},
    {0x00, 0x18, 0x14, 0x12, 0x3e, 0x10, 0x38, 0x00}, {0x00, 0x3e, 0x02, 0x1e, 0x20, 0x22, 0x1c, 0x00},
    {0x00, 0x3c, 0x02, 0x1e, 0x22, 0x22, 0x1c, 0x00}, {0x00, 0x3e, 0x20, 0x10, 0x08, 0x04, 0x04, 0x00},
    {0x00, 0x1c, 0x22, 0x1c, 0x22, 0x22, 0x1c, 0x00}, {0x00, 0x1c, 0x22, 0x22, 0x3c, 0x20, 0x1e, 0x00},
    {0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x04, 0x00}, {0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x04, 0x02},
    {0x10, 0x08, 0x04, 0x02, 0x04, 0x08, 0x10, 0x00}, {0x00, 0x00, 0x3e, 0x00, 0x00, 0x3e, 0x00, 0x00},
    {0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00}, {0x00, 0x1c, 0x22, 0x20, 0x18, 0x04, 0x00, 0x04},
    {0x00, 0x3c, 0x22, 0x3a, 0x1a, 0x42, 0x3c, 0x00}, {0x00, 0x1c, 0x22, 0x22, 0x3e, 0x22, 0x22, 0x00},
    {0x00, 0x1e, 0x22, 0x1e, 0x22, 0x22, 0x1e, 0x00}, {0x00, 0x3c, 0x02, 0x02, 0x02, 0x02, 0x3c, 0x00},
    {0x00, 0x1e, 0x22, 0x22, 0x22, 0x22, 0x1e, 0x00}, {0x00, 0x3e, 0x02, 0x1e, 0x02, 0x02, 0x3e, 0x00},
    {0x00, 0x3e, 0x02, 0x1e, 0x02, 0x02, 0x02, 0x00}, {0x00, 0x1c, 0x22, 0x02, 0x32, 0x22, 0x3c, 0x00},
    {0x00, 0x22, 0x22, 0x3e, 0x22, 0x22, 0x22, 0x00}, {0x00, 0x1c, 0x08, 0x08, 0x08, 0x08, 0x1c, 0x00},
    {0x00, 0x20, 0x20, 0x20, 0x20, 0x22, 0x1c, 0x00}, {0x00, 0x12, 0x0a, 0x06, 0x0a, 0x12, 0x22, 0x00},
    {0x00, 0x02, 0x02, 0x02, 0x02, 0x02, 0x3e, 0x00}, {0x00, 0x22, 0x36, 0x2a, 0x22, 0x22, 0x22, 0x00},
    {0x00, 0x22, 0x26, 0x2a, 0x32, 0x22, 0x22, 0x00}, {0x00, 0x1c, 0x22, 0x22, 0x22, 0x22, 0x1c, 0x00},
    {0x00, 0x1e, 0x22, 0x22, 0x1e, 0x02, 0x02, 0x00}, {0x00, 0x1c, 0x22, 0x22, 0x22, 0x1c, 0x30, 0x00},
    {0x00, 0x1e, 0x22, 0x22, 0x1e, 0x22, 0x22, 0x00}, {0x00, 0x3c, 0x02, 0x1c, 0x20, 0x20, 0x1e, 0x00},
    {0x00, 0x3e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00}, {0x00, 0x22, 0x22, 0x22, 0x22, 0x22, 0x1c, 0x00},
    {0x00, 0x22, 0x22, 0x22, 0x14, 0x14, 0x08, 0x00}, {0x00, 0x22, 0x22, 0x22, 0x2a, 0x36, 0x22, 0x00},
    {0x22, 0x22, 0x14, 0x08, 0x14, 0x22, 0x22, 0x00}, {0x00, 0x22, 0x22, 0x22, 0x14, 0x08, 0x08, 0x00},
    {0x00, 0x3e, 0x10, 0x08, 0x04, 0x02, 0x3e, 0x00}, {0x00, 0x1c, 0x04, 0x04, 0x04, 0x04, 0x1c, 0x00},
    {0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00}, {0x00, 0x1c, 0x10, 0x10, 0x10, 0x10, 0x1c, 0x00},
    {0x00, 0x08, 0x14, 0x22, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00},
    {0x00, 0x02, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x3c, 0x22, 0x22, 0x22, 0x5c, 0x00},
    {0x02, 0x02, 0x1e, 0x22, 0x22, 0x22, 0x1e, 0x00}, {0x00, 0x00, 0x1c, 0x22, 0x02, 0x02, 0x3c, 0x00},
    {0x20, 0x20, 0x3c, 0x22, 0x22, 0x22, 0x3c, 0x00}, {0x00, 0x00, 0x1c, 0x22, 0x3e, 0x02, 0x3c, 0x00},
    {0x00, 0x38, 0x04, 0x1e, 0x04, 0x04, 0x04, 0x00}, {0x00, 0x00, 0x3c, 0x22, 0x22, 0x3c, 0x20, 0x1e},
    {0x02, 0x02, 0x02, 0x1e, 0x22, 0x22, 0x22, 0x00}, {0x00, 0x04, 0x00, 0x06, 0x04, 0x04, 0x0c, 0x00},
    {0x00, 0x10, 0x00, 0x10, 0x10, 0x10, 0x12, 0x0c}, {0x02, 0x02, 0x12, 0x0a, 0x06, 0x0a, 0x12, 0x00},
    {0x0c, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1c, 0x00}, {0x00, 0x00, 0x1e, 0x2a, 0x2a, 0x2a, 0x2a, 0x00},
    {0x00, 0x00, 0x1a, 0x26, 0x22, 0x22, 0x22, 0x00}, {0x00, 0x00, 0x1c, 0x22, 0x22, 0x22, 0x1c, 0x00},
    {0x00, 0x00, 0x1e, 0x22, 0x22, 0x1e, 0x02, 0x02}, {0x00, 0x00, 0x3c, 0x22, 0x22, 0x3c, 0x20, 0x20},
    {0x00, 0x00, 0x1a, 0x26, 0x02, 0x02, 0x02, 0x00}, {0x00, 0x00, 0x3c, 0x02, 0x1c, 0x20, 0x1e, 0x00},
    {0x04, 0x04, 0x1e, 0x04, 0x04, 0x04, 0x18, 0x00}, {0x00, 0x00, 0x22, 0x22, 0x22, 0x32, 0x2c, 0x00},
    {0x00, 0x00, 0x22, 0x22, 0x14, 0x14, 0x08, 0x00}, {0x00, 0x00, 0x22, 0x2a, 0x2a, 0x2a, 0x14, 0x00},
    {0x00, 0x00, 0x22, 0x14, 0x08, 0x14, 0x22, 0x00}, {0x00, 0x00, 0x22, 0x22, 0x22, 0x3c, 0x20, 0x1e},
    {0x00, 0x00, 0x3e, 0x10, 0x08, 0x04, 0x3e, 0x00}, {0x18, 0x04, 0x04, 0x02, 0x04, 0x04, 0x18, 0x00},
    {0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00}, {0x0c, 0x10, 0x10, 0x20, 0x10, 0x10, 0x0c, 0x00},
    {0x00, 0x00, 0x00, 0x2c, 0x1a, 0x00, 0x00, 0x00}, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

static inline void set_color(uint8_t *p, uint32_t rgba)
{
    p[0] = rgba >> 24;
    p[1] = rgba >> 16 & 0xff;
    p[2] = rgba >>  8 & 0xff;
    p[3] = rgba       & 0xff;
}

static inline uint8_t *get_pixel_pos_buf(const struct canvas *canvas, int px, int py)
{
    return canvas->buf + (py * canvas->w + px) * BYTES_PER_PIXEL;
}

void ngli_drawutils_draw_rect(struct canvas *canvas, const struct rect *rect, uint32_t color)
{
    uint8_t *buf = get_pixel_pos_buf(canvas, rect->x, rect->y);
    const int stride = canvas->w * BYTES_PER_PIXEL;
    for (int y = 0; y < rect->h; y++) {
        for (int x = 0; x < rect->w; x++)
            set_color(buf + x * BYTES_PER_PIXEL, color);
        buf += stride;
    }
}

void ngli_drawutils_print(struct canvas *canvas, int x, int y, const char *str, uint32_t color)
{
    int px = 0, py = 0;
    for (int i = 0; str[i]; i++) {
        if (str[i] == '\n') {
            py++;
            px = 0;
            continue;
        }
        for (int char_y = 0; char_y < NGLI_FONT_H; char_y++) {
            for (int char_x = 0; char_x < NGLI_FONT_W; char_x++) {
                const int pix_x = x + px * NGLI_FONT_W + char_x;
                const int pix_y = y + py * NGLI_FONT_H + char_y;
                if (pix_x < 0 || pix_y < 0 || pix_x >= canvas->w || pix_y >= canvas->h)
                    continue;
                uint8_t *p = get_pixel_pos_buf(canvas, pix_x, pix_y);
                if (font8[str[i] & 0x7f][char_y] & (1 << char_x))
                    set_color(p, color);
            }
        }
        px++;
    }
}

#if 0
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

static int save_ppm(const char *filename, uint8_t *data, int width, int height)
{
    int ret = 0;
    int flags = O_WRONLY|O_CREAT|O_TRUNC;
#ifdef O_BINARY
    flags |= O_BINARY;
#endif
    int fd = open(filename, flags, 0644);
    if (fd == -1) {
        fprintf(stderr, "Unable to open '%s'\n", filename);
        return -1;
    }

    uint8_t *buf = malloc(32 + width * height * 3);
    if (!buf) {
        ret = -1;
        goto end;
    }

    const int header_size = snprintf((char *)buf, 32, "P5 %d %d 255\n", width, height);
    if (header_size < 0) {
        ret = -1;
        fprintf(stderr, "Failed to write PPM header\n");
        goto end;
    }

    uint8_t *dst = buf + header_size;
    memcpy(dst, data, width * height);

    const int size = header_size + width * height;
    ret = write(fd, buf, size);
    if (ret < 0) {
        fprintf(stderr, "Failed to write PPM data\n");
        goto end;
    }

end:
    free(buf);
    close(fd);
    return ret;
}
#endif

int ngli_drawutils_get_font_atlas(struct canvas *c_dst)
{
    struct canvas c = {.w = 16 * NGLI_FONT_W, .h = 8 * NGLI_FONT_H};
    c.buf = ngli_calloc(c.w * c.h, 1);
    if (!c.buf)
        return NGL_ERROR_MEMORY;

    uint8_t chr = 0;
    for (int y = 0; y < 8; y++) {
        for (int x = 0; x < 16; x++) {
            for (int char_y = 0; char_y < NGLI_FONT_H; char_y++) {
                for (int char_x = 0; char_x < NGLI_FONT_W; char_x++) {
                    const int pix_x = x * NGLI_FONT_W + char_x;
                    const int pix_y = y * NGLI_FONT_H + char_y;
                    uint8_t *p = c.buf + (pix_y * c.w + pix_x);
                    if (font8[chr][char_y] & (1 << char_x))
                        *p = 0xff;
                }
            }
            chr++;
        }
    }

    //save_ppm("/tmp/atlas.ppm", c.buf, c.w, c.h);

    *c_dst = c;
    return 0;
}
